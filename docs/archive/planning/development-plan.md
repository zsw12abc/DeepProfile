# DeepProfile Chrome Extension 开发文档

本文档旨在指导 AI 助手一步步完成 DeepProfile Chrome 插件的开发。本项目用于在知乎页面分析用户画像，辅助理性交流。

## 1. 项目概述
*   **项目名称**: DeepProfile
*   **核心功能**: 监听知乎评论区 -> 提取用户 ID -> 抓取用户动态 -> 调用 LLM 分析 -> 展示用户画像。
*   **目标平台**: Chrome 浏览器 (Manifest V3)。

## 2. 技术栈规范
*   **语言**: TypeScript (必须，确保类型安全)。
*   **构建工具**: Vite 或 Plasmo (推荐 Plasmo，因为它对 Chrome 插件开发支持最好)。
*   **UI 框架**: React 或 Preact (轻量级)。
*   **测试框架**: Vitest (单元测试)。
*   **包管理器**: pnpm 或 npm。

## 3. 敏感数据与安全
*   **原则**: 任何 API Key 均不得硬编码在代码中。
*   **存储**: 所有敏感配置（API Key, Base URL）必须存储在 `chrome.storage.local` 中。
*   **版本控制**: `.env` 文件及包含密钥的测试文件必须加入 `.gitignore`。

## 4. 模块化开发路线图

请 AI 开发者按照以下阶段顺序执行，**每个阶段完成后必须通过自动化测试才能进入下一阶段**。

### 阶段一：项目脚手架与配置模块 (✅ 已完成)
- [x] 初始化项目结构
- [x] 实现 `ConfigService`
- [x] 完成设置页面 (Options Page)

### 阶段二：知乎数据获取模块 (✅ 已完成)
- [x] 实现 `ZhihuClient`
- [x] 数据清洗与截断
- [x] 上下文感知 (Context-Aware)

### 阶段三：AI 服务集成 (✅ 已完成)
- [x] 对接 OpenAI/DeepSeek/Qwen/Gemini/Ollama
- [x] 实现 Prompt 工程 (价值取向分析)
- [x] 标签系统 (LabelService)

### 阶段四：UI 注入与交互 (✅ 已完成)
- [x] 知乎评论区/主页注入
- [x] Reddit 注入 (初步支持)
- [x] 结果展示卡片 (ProfileCard)

### 阶段五：基础功能完善 (✅ 已完成)
- [x] 历史记录与缓存 (History Service)
- [x] 导出与分享 (Export Service)
- [x] UI/UX 细节优化

### 阶段六：评论区舆情总结 (✅ 已完成 v0.5)
**目标**: 提供当前评论区的宏观舆论概览，帮助用户快速了解争议焦点。

1.  **数据提取 (DOM Extraction)**:
    *   **策略**: 仅解析当前页面已加载的评论 DOM 元素，**不调用知乎 API**，彻底规避风控风险。
    *   **内容**: 提取评论者昵称、评论正文、点赞数（作为权重参考）。
    *   **适配**: 支持回答下方的折叠评论区和文章底部的评论区。
2.  **舆情分析服务 (Comment Analysis Service)**:
    *   **Prompt 工程**: 设计专门的 Prompt，用于分析"观点阵营"、"主要论点"和"情绪倾向"。
    *   **输出结构**: 
        *   支持方/反对方/中立吃瓜比例。
        *   核心争议点总结。
        *   典型评论摘录。
3.  **UI 交互**:
    *   **注入点**: 在评论区顶部（Header 区域）添加"📊 总结本页观点"按钮。
    *   **展示**: 独立的分析结果卡片，展示饼图或进度条及文字总结。

### 阶段七：多平台扩展 (✅ 已完成 v0.6)
**目标**: 探索更多平台支持。

- [x] **Reddit**: 完整支持 Reddit 用户画像分析
- [ ] **Twitter/X**: 英文推文分析 (待开发)
- [ ] **微博**: 用户主页分析 (待开发)

### 阶段八：分析准确度与一致性优化 (✅ 已完成 v0.7)
**目标**: 提升用户画像分析的准确度，并确保AI生成的摘要与数值标签分数保持一致。

1.  **一致性验证机制**:
    *   **标签-摘要关联**: 高分标签会在AI摘要中得到明确体现
    *   **ConsistencyService**: 新增专门的服务验证并修复摘要与标签的一致性
    *   **证据支撑**: 确保分析证据与标签分数相匹配
    *   **CRITICAL CONSISTENCY RULE**: 在LLM提示词中明确要求AI保持摘要与数值分数的一致性

2.  **AI摘要优化**:
    *   **准确性提升**: 优化提示词工程，提高AI分析的准确性
    *   **一致性保证**: 确保AI生成的摘要准确反映标签分数所代表的价值倾向
    *   **后处理机制**: 实现后处理步骤，自动调整摘要内容以匹配标签分数

### 阶段九：未来规划
**目标**: 探索更多功能扩展。

- [ ] **Bilibili**: 评论区与动态分析
- [ ] **高级分析功能**: 情绪趋势分析、话题演变追踪
- [ ] **API接口**: 提供REST API供其他应用集成